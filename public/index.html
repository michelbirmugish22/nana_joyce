<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="utf-8" />
    <meta http-equiv="X-UA-Compatible" content="IE=edge" />
    <meta
      name="viewport"
      content="width=device-width, initial-scale=1, shrink-to-fit=no"
    />
    <meta name="description" content="Num√©risation des documents UCB" />
    <meta name="author" content="NANA JOYCE" />
    <meta
      name="keywords"
      content="Application, Num√©risation, Scanner, Document, Universit√©, UCB, Catholique, Etudiant, LMD, Nana, Joyce, Projet, Tutor√©"
    />

    <link rel="preconnect" href="https://fonts.gstatic.com" />
    <link rel="shortcut icon" href="img/icons/icon-48x48.png" />

    <link rel="canonical" href="https://demo-basic.adminkit.io/" />

    <title>Num√©risation de documents | UCB Par NANA et JOYCE</title>

    <link href="css/app.css" rel="stylesheet" />
    <script src="https://code.jquery.com/jquery-3.7.0.min.js"></script>
    <script src="https://cdn.datatables.net/1.13.6/js/jquery.dataTables.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
    <link
      href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;600&display=swap"
      rel="stylesheet"
    />
  </head>
  <script>
    $(function () {
      $.getJSON("/api/session")
        .done(function (data) {
          if (!data || !data.connected) {
            window.location.href = "./login";
            return;
          }
          // Optionnel : mettre √† jour l'UI avec les infos utilisateur si fournies
          if (data.user) {
            if (data.user.name) $("#userName").text(data.user.name);
            if (data.user.photo) $("#userPhoto").attr("src", data.user.photo);
          }
        })
        .fail(function () {
          // En cas d'erreur, rediriger vers la page de login
          window.location.href = "./login";
        });
    });
  </script>
  <body>
    <div class="wrapper">
      <nav id="sidebar" class="sidebar js-sidebar">
        <!-- Chargement ici  -->
      </nav>

      <div class="main">
        <!-- <div id="entete"></div> -->
        <nav class="navbar navbar-expand navbar-light navbar-bg">
          <a class="sidebar-toggle js-sidebar-toggle">
            <i class="hamburger align-self-center"></i>
          </a>

          <div class="navbar-collapse collapse">
            <ul class="navbar-nav navbar-align">
              <li class="nav-item dropdown">
                <a
                  class="nav-icon dropdown-toggle d-inline-block d-sm-none"
                  href="#"
                  data-bs-toggle="dropdown"
                >
                  <i class="align-middle" data-feather="settings"></i>
                </a>

                <a
                  class="nav-link dropdown-toggle d-none d-sm-inline-block"
                  href="#"
                  data-bs-toggle="dropdown"
                >
                  <img
                    id="userPhoto"
                    src="./img/image_ucb.png"
                    class="avatar img-fluid rounded me-1"
                    alt="Charles Hall"
                  />
                  <span class="text-dark" id="userName">Michel</span>
                </a>
                <div class="dropdown-menu dropdown-menu-end">
                  <a class="dropdown-item" href="#"
                    ><i class="align-middle me-1" data-feather="user"></i>
                    Profil</a
                  >
                  <div class="dropdown-divider"></div>
                  <a class="dropdown-item" id="logout_btn" href="#"
                    >Se d√©connecter</a
                  >
                </div>
              </li>
            </ul>
          </div>
        </nav>
        <main class="content">
          <div class="container-fluid p-0">
            <h1 class="h3 mb-3">
              <strong>Bienvenue</strong>
              <span id="welcome_name">...</span>
            </h1>
            <!-- ============================= -->
            <!--       ROW : STATS + CALENDRIER -->
            <!-- ============================= -->
            <div class="row">
              <!-- üü¶ COL 8 : Cartes de stats -->
              <div class="col-12 col-lg-8">
                <div class="row g-3">
                  <!-- Carte 1 -->
                  <div class="col-12 col-md-6">
                    <div class="card">
                      <div class="card-body">
                        <div class="row">
                          <div class="col mt-0">
                            <h5 class="card-title">Documents</h5>
                          </div>
                          <div class="col-auto">
                            <div class="stat text-primary">
                              <i class="align-middle" data-feather="file"></i>
                            </div>
                          </div>
                        </div>
                        <h1 class="mt-1 mb-3" id="nb_document">0</h1>
                        <div class="mb-0">
                          <span class="text-danger">
                            <i
                              class="mdi mdi-arrow-bottom-right"
                              id="doc_pourcentage_icon"
                            ></i>
                            <span id="doc_pourcentage">0%</span>
                          </span>
                          <span class="text-muted">Cette semaine</span>
                        </div>
                      </div>
                    </div>
                  </div>

                  <!-- Carte 2 -->
                  <div class="col-12 col-md-6">
                    <div class="card">
                      <div class="card-body">
                        <div class="row">
                          <div class="col mt-0">
                            <h5 class="card-title">Recherches</h5>
                          </div>
                          <div class="col-auto">
                            <div class="stat text-primary">
                              <i class="align-middle" data-feather="users"></i>
                            </div>
                          </div>
                        </div>
                        <h1 class="mt-1 mb-3" id="nb_visitors">0</h1>
                        <div class="mb-0">
                          <span id="visitors_stats" class="text-success">
                            <i
                              class="mdi mdi-arrow-bottom-right"
                              id="visitors_icon"
                            ></i>
                            <span id="visitors_pourcentage">0%</span>
                          </span>
                          <span class="text-muted"
                            >Depuis la semaine pass√©e</span
                          >
                        </div>
                      </div>
                    </div>
                  </div>

                  <!-- Carte 3 -->
                  <div class="col-12 col-md-6">
                    <div class="card">
                      <div class="card-body">
                        <div class="row">
                          <div class="col mt-0">
                            <h5 class="card-title">Consultations (Ce mois)</h5>
                          </div>
                          <div class="col-auto">
                            <div class="stat text-primary">
                              <i
                                class="align-middle"
                                data-feather="activity"
                              ></i>
                            </div>
                          </div>
                        </div>
                        <h1 class="mt-1 mb-3" id="consult_month">0</h1>
                        <div class="mb-0">
                          <span id="consult_month_stat" class="text-success">
                            <i
                              class="mdi mdi-arrow-bottom-right"
                              id="consult_month_icon"
                            ></i>
                            <span id="consult_month_pourcentage">0%</span>
                          </span>
                          <span class="text-muted">Depuis le mois pass√©</span>
                        </div>
                      </div>
                    </div>
                  </div>

                  <!-- Carte 4 -->
                  <div class="col-12 col-md-6">
                    <div class="card">
                      <div class="card-body">
                        <div class="row">
                          <div class="col mt-0">
                            <h5 class="card-title">Docs Confidentiels</h5>
                          </div>
                          <div class="col-auto">
                            <div class="stat text-primary">
                              <i class="align-middle" data-feather="lock"></i>
                            </div>
                          </div>
                        </div>
                        <h1 class="mt-1 mb-3" id="nb_confidentiels">0</h1>
                        <div class="mb-0">
                          <span id="conf_stat" class="text-danger">
                            <i
                              class="mdi mdi-arrow-bottom-right"
                              id="conf_icon"
                            ></i>
                            <span id="conf_pourcentage">0%</span>
                          </span>
                          <span class="text-muted">Total</span>
                        </div>
                      </div>
                    </div>
                  </div>
                </div>
              </div>

              <!-- üü© COL 4 : Calendrier -->
              <div class="col-12 col-lg-4">
                <div class="card">
                  <div class="card-body d-flex">
                    <div class="align-self-center w-100">
                      <!-- <div id="datetimepicker-dashboard"></div> -->
                      <img
                        src="./img/image_ucb.png"
                        alt=""
                        style="width: 100%"
                      />
                    </div>
                  </div>
                </div>
              </div>
            </div>

            <!-- ============================= -->
            <!--       ROW : GRAPHIQUES 6 / 6 -->
            <!-- ============================= -->
            <div class="row mt-4">
              <!-- Graphique 1 -->
              <div class="col-12 col-lg-6 d-flex">
                <div class="card flex-fill w-100">
                  <div class="card-header">
                    <h5 class="card-title mb-0">Representation graphique</h5>
                  </div>
                  <div class="card-body d-flex">
                    <div class="align-self-center w-100">
                      <div class="py-3 chart chart-xs">
                        <canvas id="chartjs-dashboard-pie"></canvas>
                      </div>

                      <table class="table mb-0">
                        <tbody>
                          <tr>
                            <td>Documents</td>
                            <td class="text-end" id="txt_nb_document"></td>
                          </tr>
                          <tr>
                            <td>Consultations ce mois</td>
                            <td class="text-end" id="txt_consult_month"></td>
                          </tr>
                        </tbody>
                      </table>
                    </div>
                  </div>
                </div>
              </div>
              <div class="col-12 col-lg-6 d-flex">
                <div class="card">
                  <div class="card-header">
                    <h5 class="card-title">Calendrier</h5>
                  </div>
                  <div class="card-body d-flex">
                    <div class="align-self-center w-100">
                      <div id="datetimepicker-dashboard"></div>
                    </div>
                  </div>
                </div>
              </div>
            </div>
          </div>
        </main>

        <div id="footer"></div>
      </div>
    </div>

    <script>
      document.addEventListener("DOMContentLoaded", function () {
        var ctx = document
          .getElementById("chartjs-dashboard-line")
          .getContext("2d");
        var gradient = ctx.createLinearGradient(0, 0, 0, 225);
        gradient.addColorStop(0, "rgba(215, 227, 244, 1)");
        gradient.addColorStop(1, "rgba(215, 227, 244, 0)");
        // Line chart
        new Chart(document.getElementById("chartjs-dashboard-line"), {
          type: "line",
          data: {
            labels: [
              "Jan",
              "Feb",
              "Mar",
              "Apr",
              "May",
              "Jun",
              "Jul",
              "Aug",
              "Sep",
              "Oct",
              "Nov",
              "Dec",
            ],
            datasets: [
              {
                label: "Sales ($)",
                fill: true,
                backgroundColor: gradient,
                borderColor: window.theme.primary,
                data: [
                  2115, 1562, 1584, 1892, 1587, 1923, 2566, 2448, 2805, 3438,
                  2917, 3327,
                ],
              },
            ],
          },
          options: {
            maintainAspectRatio: false,
            legend: {
              display: false,
            },
            tooltips: {
              intersect: false,
            },
            hover: {
              intersect: true,
            },
            plugins: {
              filler: {
                propagate: false,
              },
            },
            scales: {
              xAxes: [
                {
                  reverse: true,
                  gridLines: {
                    color: "rgba(0,0,0,0.0)",
                  },
                },
              ],
              yAxes: [
                {
                  ticks: {
                    stepSize: 1000,
                  },
                  display: true,
                  borderDash: [3, 3],
                  gridLines: {
                    color: "rgba(0,0,0,0.0)",
                  },
                },
              ],
            },
          },
        });
      });
    </script>
    <script>
      document.addEventListener("DOMContentLoaded", async function () {
        // R√©cup√©rer documents
        const documents = await fetch("/api/document").then((r) => r.json());
        const recherches = await fetch("/api/rechercher").then((r) => r.json());

        let nbDocs = Array.isArray(documents) ? documents.length : 0;
        let nbRech = Array.isArray(recherches) ? recherches.length : 0;

        // Remplir le Pie Chart
        new Chart(document.getElementById("chartjs-dashboard-pie"), {
          type: "pie",
          data: {
            labels: ["Recherches", "Documents"],
            datasets: [
              {
                data: [nbRech, nbDocs],
                backgroundColor: [window.theme.primary, window.theme.warning],
                borderWidth: 5,
              },
            ],
          },
          options: {
            responsive: !window.MSInputMethodContext,
            maintainAspectRatio: false,
            legend: {
              display: false,
            },
            cutoutPercentage: 75,
          },
        });
      });
    </script>

    <script>
      document.addEventListener("DOMContentLoaded", function () {
        // Pie chart
        new Chart(document.getElementById("chartjs-dashboard-pie"), {
          type: "pie",
          data: {
            labels: ["Chrome", "Firefox", "IE"],
            datasets: [
              {
                data: [4306, 3801, 1689],
                backgroundColor: [
                  window.theme.primary,
                  window.theme.warning,
                  window.theme.danger,
                ],
                borderWidth: 5,
              },
            ],
          },
          options: {
            responsive: !window.MSInputMethodContext,
            maintainAspectRatio: false,
            legend: {
              display: false,
            },
            cutoutPercentage: 75,
          },
        });
      });
    </script>

    <script>
      document.addEventListener("DOMContentLoaded", function () {
        var date = new Date(Date.now() - 0 * 24 * 60 * 60 * 1000);
        var defaultDate =
          date.getUTCFullYear() +
          "-" +
          (date.getUTCMonth() + 1) +
          "-" +
          date.getUTCDate();

        // Pr√©parer la locale fran√ßaise (utilise la locale int√©gr√©e si disponible,
        // sinon on fournit une petite d√©finition de secours)
        var frLocale =
          typeof flatpickr !== "undefined" &&
          flatpickr.l10n &&
          flatpickr.l10n.fr
            ? flatpickr.l10n.fr
            : {
                weekdays: {
                  shorthand: ["Dim", "Lun", "Mar", "Mer", "Jeu", "Ven", "Sam"],
                  longhand: [
                    "Dimanche",
                    "Lundi",
                    "Mardi",
                    "Mercredi",
                    "Jeudi",
                    "Vendredi",
                    "Samedi",
                  ],
                },
                months: {
                  shorthand: [
                    "Jan",
                    "F√©v",
                    "Mar",
                    "Avr",
                    "Mai",
                    "Jui",
                    "Juil",
                    "Ao√ª",
                    "Sep",
                    "Oct",
                    "Nov",
                    "D√©c",
                  ],
                  longhand: [
                    "Janvier",
                    "F√©vrier",
                    "Mars",
                    "Avril",
                    "Mai",
                    "Juin",
                    "Juillet",
                    "Ao√ªt",
                    "Septembre",
                    "Octobre",
                    "Novembre",
                    "D√©cembre",
                  ],
                },
                firstDayOfWeek: 1,
                rangeSeparator: " au ",
                weekAbbreviation: "Sem",
                scrollTitle: "Faire d√©filer pour changer",
                toggleTitle: "Cliquer pour basculer",
                time_24hr: true,
              };

        document.getElementById("datetimepicker-dashboard").flatpickr({
          inline: true,
          prevArrow: '<span title="Mois pr√©c√©dent">&laquo;</span>',
          nextArrow: '<span title="Mois suivant">&raquo;</span>',
          defaultDate: defaultDate,
          locale: frLocale,
        });
      });
    </script>
    <script>
      $(document).ready(function () {
        $("#sidebar").load("sidebar.html", function () {
          feather.replace(); // Recharger les ic√¥nes Feather apr√®s injection
        });
        $("#footer").load("footer.html", function () {});
      });
      // Charger les infos utilisateur dans l'ent√™te
      $(document).ready(function () {
        $.get("/api/session", function (data) {
          if (data.connected) {
            $("#userName").text(data.user.nom + " " + data.user.postnom);
            $("#welcome_name").text(data.user.nom + " " + data.user.postnom);
            $("#userPhoto").attr(
              "src",
              data.user.photo || "./img/image_ucb.png"
            );
          } else {
            $("#userName").text("Invit√©");
            $("#userPhoto").attr("src", "./img/image_ucb.png");
          }
        });
      });
    </script>
    <script>
      $(document).ready(function () {
        // üîπ R√©cup√©rer info utilisateur depuis la session
        $.get("/api/session", function (data) {
          if (data.connected) {
            $("#welcome_name").text(data.user.nom + " " + data.user.postnom);
          }
        });

        // üîπ Compte Documents
        $.get("/api/document", function (data) {
          if (Array.isArray(data)) {
            $("#nb_document").text(data.length);
            $("#txt_nb_document").text(data.length);

            // Exemple: calcul d'un faux pourcentage
            let pourc = Math.floor(Math.random() * 20) - 10;
            $("#doc_pourcentage").text(pourc + "%");

            if (pourc >= 0) {
              $("#doc_pourcentage_icon")
                .removeClass("text-danger")
                .addClass("text-success");
            }
          }
        });

        // üîπ Exemple Visitors
        $.get("/api/rechercher", function (data) {
          if (Array.isArray(data)) {
            $("#nb_visitors").text(data.length);

            let pourc = Math.floor(Math.random() * 15);
            $("#visitors_pourcentage").text(pourc + "%");
          }
        });

        // ================================
        // üîπ NOMBRE DE CONSULTATIONS DU MOIS
        // ================================
        $.get("/api/rechercher", function (data) {
          if (Array.isArray(data)) {
            let thisMonth = new Date().getMonth() + 1;
            let count = data.filter((r) => {
              return new Date(r.date).getMonth() + 1 === thisMonth;
            }).length;

            $("#consult_month").text(count);
            $("#txt_consult_month").text(count);

            let pourc = Math.floor(Math.random() * 20);
            $("#consult_month_pourcentage").text("+" + pourc + "%");
          }
        });

        // ================================
        // üîπ DOCUMENTS CONFIDENTIELS
        // ================================
        $.get("/api/document", function (data) {
          if (Array.isArray(data)) {
            let conf = data.filter((d) => d.niveau_conf >= 3).length;

            $("#nb_confidentiels").text(conf);

            let pourc = Math.floor(Math.random() * 10);
            $("#conf_pourcentage").text("+" + pourc + "%");
          }
        });
      });
    </script>
    <script>
      $(document).on("click", "#logout_btn", function (e) {
        e.preventDefault();
        $.ajax({
          url: "/api/logout",
          method: "POST",
          dataType: "json",
        })
          .done(function (data, textStatus, xhr) {
            window.location.href = "/";
          })
          .fail(function (xhr) {
            let msg = "Erreur serveur";
            alert(msg);
          });
      });
    </script>

    <script src="js/app.js"></script>
  </body>
</html>
