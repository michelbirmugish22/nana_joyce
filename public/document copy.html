<!DOCTYPE html>
<html lang="fr">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>Gestion des Documents</title>

    <link rel="stylesheet" href="./css/style_scanner.css" />
    <link href="css/app.css" rel="stylesheet" />

    <link
      href="https://cdn.datatables.net/1.13.6/css/jquery.dataTables.min.css"
      rel="stylesheet"
    />
    <script src="https://code.jquery.com/jquery-3.7.0.min.js"></script>
    <script src="https://cdn.datatables.net/1.13.6/js/jquery.dataTables.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
  </head>
  <body>
    <div class="wrapper">
      <nav id="sidebar" class="sidebar js-sidebar">
        <div class="sidebar-content js-simplebar">
          <a class="sidebar-brand" href="index.html">
            <span class="align-middle">UCB - Gestion Documents</span>
          </a>

          <ul class="sidebar-nav">
            <li class="sidebar-header">G√©n√©ral</li>

            <li class="sidebar-item active">
              <a class="sidebar-link" href="index.html">
                <i class="align-middle" data-feather="sliders"></i>
                <span class="align-middle">Tableau de bord</span>
              </a>
            </li>

            <li class="sidebar-header">Documents</li>

            <li class="sidebar-item">
              <a class="sidebar-link" href="documents-consultation.html">
                <i class="align-middle" data-feather="book-open"></i>
                <span class="align-middle">Consulter documents</span>
              </a>
            </li>

            <li class="sidebar-item">
              <a class="sidebar-link" href="documents-archivage.html">
                <i class="align-middle" data-feather="file-plus"></i>
                <span class="align-middle">Num√©riser / Archiver</span>
              </a>
            </li>

            <li class="sidebar-item">
              <a class="sidebar-link" href="recherche-documents.html">
                <i class="align-middle" data-feather="search"></i>
                <span class="align-middle">Recherche</span>
              </a>
            </li>

            <li class="sidebar-header">Suivi & Statistiques</li>

            <li class="sidebar-item">
              <a class="sidebar-link" href="historique.html">
                <i class="align-middle" data-feather="clock"></i>
                <span class="align-middle">Historique</span>
              </a>
            </li>

            <li class="sidebar-item">
              <a class="sidebar-link" href="notifications.html">
                <i class="align-middle" data-feather="bell"></i>
                <span class="align-middle">Notifications</span>
              </a>
            </li>

            <li class="sidebar-item">
              <a class="sidebar-link" href="statistiques.html">
                <i class="align-middle" data-feather="bar-chart-2"></i>
                <span class="align-middle">Statistiques</span>
              </a>
            </li>

            <li class="sidebar-header">Administration</li>

            <li class="sidebar-item">
              <a class="sidebar-link" href="/faculte">
                <i class="align-middle" data-feather="home"></i>
                <span class="align-middle">Facult√©s</span>
              </a>
            </li>

            <li class="sidebar-item">
              <a class="sidebar-link" href="/service">
                <i class="align-middle" data-feather="airplay"></i>
                <span class="align-middle">Services</span>
              </a>
            </li>
            <li class="sidebar-item">
              <a class="sidebar-link" href="/categorie">
                <i class="align-middle" data-feather="airplay"></i>
                <span class="align-middle">Cat√©gories</span>
              </a>
            </li>

            <li class="sidebar-item">
              <a class="sidebar-link" href="gestion-utilisateurs.html">
                <i class="align-middle" data-feather="users"></i>
                <span class="align-middle">Gestion utilisateurs</span>
              </a>
            </li>

            <li class="sidebar-item">
              <a class="sidebar-link" href="roles.html">
                <i class="align-middle" data-feather="shield"></i>
                <span class="align-middle">Gestion des r√¥les</span>
              </a>
            </li>

            <li class="sidebar-item">
              <a class="sidebar-link" href="sauvegarde.html">
                <i class="align-middle" data-feather="save"></i>
                <span class="align-middle">Sauvegardes</span>
              </a>
            </li>
          </ul>

          <div class="sidebar-cta">
            <div class="sidebar-cta-content">
              <strong class="d-inline-block mb-2">UCB</strong>
              <div class="mb-3 text-sm">
                Syst√®me de gestion documentaire de l‚ÄôUniversit√© Catholique de
                Bukavu.
              </div>
            </div>
          </div>
        </div>
      </nav>

      <div class="main">
        <nav class="navbar navbar-expand navbar-light navbar-bg">
          <a class="sidebar-toggle js-sidebar-toggle"
            ><i class="hamburger align-self-center"></i
          ></a>
        </nav>

        <main class="content">
          <div class="container-fluid p-0">
            <h1 class="h3 mb-3">Gestion des Documents</h1>
            <div class="card m-2">
              <div class="card-body">
                <input
                  type="radio"
                  class=""
                  name="numeriser"
                  id="scan"
                  checked
                />
                <label for="scan" class="btn btn-primary">Scanning</label>

                <input type="radio" class="" name="numeriser" id="upload" />
                <label for="upload" class="btn btn-primary">Uploading</label>
              </div>
            </div>
            <div class="row" id="scanning_div">
              <h1>üìÑ Scanner de documents avanc√©</h1>

              <div class="camera-container">
                <video id="video" autoplay playsinline></video>
                <canvas id="canvas" style="display: none"></canvas>
              </div>

              <div class="controls">
                <button class="btn" id="capture">üì∏ Capturer</button>
                <button class="btn" id="generate">üßæ G√©n√©rer PDF</button>
                <button class="btn">
                  <a id="download" download="document.pdf">‚¨áÔ∏è T√©l√©charger</a>
                </button>
              </div>
              <h2>üìÇ Mes documents scann√©s</h2>
              <div id="pdf-list"></div>
              <button id="refresh-pdfs">üîÑ Rafra√Æchir la liste</button>

              <div id="pages"></div>

              <!-- Popup d'√©dition -->
              <div id="editor-modal" class="modal">
                <canvas id="edit-canvas"></canvas>
                <div class="edit-controls">
                  <button id="rotate-left">‚Ü©Ô∏è</button>
                  <button id="rotate-right">‚Ü™Ô∏è</button>
                  <button id="enhance">‚ú® Am√©liorer</button>
                  <button id="save-edit">‚úÖ Sauver</button>
                  <button id="cancel-edit">‚ùå Annuler</button>
                </div>
              </div>
              <form id="documentForm">
                <input type="hidden" id="documentId" />

                <div class="mb-3">
                  <label for="description" class="form-label"
                    >Description</label
                  >
                  <input
                    type="text"
                    id="description"
                    class="form-control"
                    placeholder="Description du document"
                    required
                  />
                </div>

                <div class="mb-3">
                  <label for="code" class="form-label">Code</label>
                  <input
                    type="text"
                    id="code"
                    class="form-control"
                    placeholder="Code interne"
                    required
                  />
                </div>

                <div class="mb-3">
                  <label for="categorie" class="form-label">Cat√©gorie</label>
                  <select id="categorie" class="form-control" required></select>
                </div>

                <div class="mb-3">
                  <label for="niveau_conf" class="form-label"
                    >Niveau de confidentialit√©</label
                  >
                  <select id="niveau_conf" class="form-control" required>
                    <option value="1">1 - Public</option>
                    <option value="2">2 - Interne</option>
                    <option value="3">3 - Confidentiel</option>
                    <option value="4">4 - Tr√®s confidentiel</option>
                  </select>
                </div>
              </form>
            </div>

            <div class="row" id="uploading_div" style="display: none">
              <!-- Formulaire √† gauche -->
              <div class="col-md-4">
                <div class="card">
                  <div class="card-body">
                    <h5 class="card-title">Ajouter / Modifier un document</h5>
                    <form id="documentForm">
                      <input type="hidden" id="documentId" />

                      <div class="mb-3">
                        <label for="description" class="form-label"
                          >Description</label
                        >
                        <input
                          type="text"
                          id="description"
                          class="form-control"
                          placeholder="Description du document"
                          required
                        />
                      </div>

                      <div class="mb-3">
                        <label for="code" class="form-label">Code</label>
                        <input
                          type="text"
                          id="code"
                          class="form-control"
                          placeholder="Code interne"
                          required
                        />
                      </div>

                      <div class="mb-3">
                        <label for="categorie" class="form-label"
                          >Cat√©gorie</label
                        >
                        <select
                          id="categorie"
                          class="form-control"
                          required
                        ></select>
                      </div>

                      <div class="mb-3">
                        <label for="niveau_conf" class="form-label"
                          >Niveau de confidentialit√©</label
                        >
                        <select id="niveau_conf" class="form-control" required>
                          <option value="1">1 - Public</option>
                          <option value="2">2 - Interne</option>
                          <option value="3">3 - Confidentiel</option>
                          <option value="4">4 - Tr√®s confidentiel</option>
                        </select>
                      </div>

                      <div class="mb-3">
                        <label class="form-label">Mode d'ajout</label>
                        <div>
                          <input
                            type="radio"
                            name="mode"
                            value="upload"
                            checked
                          />
                          Upload
                          <input
                            type="radio"
                            name="mode"
                            value="scan"
                            class="ms-3"
                          />
                          Scanning
                        </div>
                      </div>

                      <div class="mb-3" id="fileInputContainer">
                        <label for="file" class="form-label">Fichier</label>
                        <input
                          type="file"
                          id="file"
                          class="form-control"
                          required
                        />
                      </div>

                      <button
                        type="submit"
                        class="btn btn-primary w-100"
                        id="saveBtn"
                      >
                        Ajouter
                      </button>
                      <button
                        type="button"
                        class="btn btn-secondary w-100 mt-2"
                        id="cancelBtn"
                        style="display: none"
                      >
                        Annuler
                      </button>
                    </form>
                    <div id="formMessage" class="mt-2"></div>
                  </div>
                </div>
              </div>

              <!-- DataTable √† droite -->
              <div class="col-md-8">
                <div class="card">
                  <div class="card-body">
                    <table
                      id="documentTable"
                      class="display"
                      style="width: 100%"
                    >
                      <thead>
                        <tr>
                          <th>Description</th>
                          <th>Code</th>
                          <th>Cat√©gorie</th>
                          <th>Date</th>
                          <th>Niveau</th>
                          <th>Actions</th>
                        </tr>
                      </thead>
                      <tbody></tbody>
                    </table>
                  </div>
                </div>
              </div>
            </div>
          </div>
        </main>

        <footer class="footer">
          <div class="container-fluid">
            <div class="row text-muted">
              <div class="col-6 text-start">
                <p class="mb-0"><strong>UCB - Gestion des documents</strong></p>
              </div>
            </div>
          </div>
        </footer>
      </div>
    </div>

    <script type="module" src="./js/app.js"></script>
    <script src="./js/script_scanner.js"></script>

    <script>
      $(document).ready(function () {
        // afficher le formulaire de scanning ou d'upload
        $('input[name="numeriser"]').change(function () {
          if ($(this).attr("id") === "scan") {
            // On affiche la div scanning_div
            $("#scanning_div").show();
            $("#uploading_div").hide();
          } else {
            $("#scanning_div").hide();

            $("#uploading_div").show();
          }
        });

        // Charger les cat√©gories dans le select
        async function loadCategories() {
          const res = await fetch("/api/categorie");
          const categories = await res.json();
          $("#categorie").html("");
          categories.forEach((cat) => {
            $("#categorie").append(
              `<option value="${cat.id}">${cat.designation}</option>`
            );
          });
        }
        loadCategories();

        let table = $("#documentTable").DataTable({
          ajax: {
            url: "/api/document",
            dataSrc: "",
          },
          columns: [
            { data: "description" },
            { data: "code" },
            { data: "categorie_designation" }, // Le backend doit renvoyer la d√©signation de la cat√©gorie
            { data: "date_created" },
            { data: "niveau_conf" },
            {
              data: null,
              render: function (data, type, row) {
                return `
            <button class="btn btn-sm btn-info showBtn">Afficher</button>
            <button class="btn btn-sm btn-danger deleteBtn">Supprimer</button>
          `;
              },
            },
          ],
        });

        // Changement de mode : upload ou scan
        $('input[name="mode"]').change(function () {
          if ($(this).val() === "scan") {
            $("#fileInputContainer label").text("Scanner le document");
          } else {
            $("#fileInputContainer label").text("Fichier");
          }
        });

        // Ajouter / Modifier
        $("#documentForm").submit(async function (e) {
          e.preventDefault();
          const id = $("#documentId").val();
          const description = $("#description").val().trim();
          const code = $("#code").val().trim();
          const categorie_id = $("#categorie").val();
          const niveau_conf = $("#niveau_conf").val();
          const mode = $('input[name="mode"]:checked').val();
          const file = $("#file")[0].files[0];

          if (!description || !code || !categorie_id || !niveau_conf || !file)
            return;

          const formData = new FormData();
          formData.append("description", description);
          formData.append("code", code);
          formData.append("categorie_id", categorie_id);
          formData.append("niveau_conf", niveau_conf);
          formData.append("mode", mode);
          formData.append("file", file);

          const url = id ? `/api/document/${id}` : "/api/document";
          const method = id ? "PUT" : "POST";

          try {
            const res = await fetch(url, { method, body: formData });
            const result = await res.json();
            $("#formMessage").html(
              `<span class="${res.ok ? "text-success" : "text-danger"}">${
                result.message
              }</span>`
            );
            $("#documentForm")[0].reset();
            $("#documentId").val("");
            $("#saveBtn").text("Ajouter");
            $("#cancelBtn").hide();
            table.ajax.reload();
          } catch (err) {
            console.error(err);
            $("#formMessage").html(
              '<span class="text-danger">Erreur serveur</span>'
            );
          }
        });

        // Annuler modification
        $("#cancelBtn").click(function () {
          $("#documentForm")[0].reset();
          $("#documentId").val("");
          $("#saveBtn").text("Ajouter");
          $(this).hide();
          $("#formMessage").html("");
        });

        // √âditer
        $("#documentTable tbody").on("click", ".editBtn", function () {
          const data = table.row($(this).parents("tr")).data();
          $("#documentId").val(data.id);
          $("#description").val(data.description);
          $("#code").val(data.code);
          $("#categorie").val(data.categorie_id);
          $("#niveau_conf").val(data.niveau_conf);
          $("#saveBtn").text("Modifier");
          $("#cancelBtn").show();
        });

        // Supprimer
        $("#documentTable tbody").on("click", ".deleteBtn", async function () {
          if (!confirm("Confirmez la suppression ?")) return;
          const data = table.row($(this).parents("tr")).data();
          try {
            const res = await fetch(`/api/document/${data.id}`, {
              method: "DELETE",
            });
            const result = await res.json();
            alert(result.message);
            table.ajax.reload();
          } catch (err) {
            console.error(err);
            alert("Erreur serveur");
          }
        });

        // Afficher
        $("#documentTable tbody").on("click", ".showBtn", function () {
          const data = table.row($(this).parents("tr")).data();
          alert(
            `Description: ${data.description}\nCode: ${data.code}\nCat√©gorie: ${data.categorie_designation}\nDate: ${data.date_created}\nNiveau: ${data.niveau_conf}`
          );
        });
      });
    </script>
  </body>
</html>
