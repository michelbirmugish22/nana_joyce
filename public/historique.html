<!DOCTYPE html>
<html lang="fr">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>Historique des Recherches</title>

    <link href="css/app.css" rel="stylesheet" />
    <link
      href="https://cdn.datatables.net/1.13.6/css/jquery.dataTables.min.css"
      rel="stylesheet"
    />

    <script src="https://code.jquery.com/jquery-3.7.0.min.js"></script>
    <script src="https://cdn.datatables.net/1.13.6/js/jquery.dataTables.min.js"></script>

    <style>
      .details-section {
        margin-top: 25px;
        padding: 20px;
        border-radius: 5px;
        background: #f9f9f9;
        border: 1px solid #ddd;
      }
      .preview-frame {
        width: 100%;
        height: 550px;
        border: 1px solid #aaa;
        display: none;
        margin-top: 20px;
      }
    </style>
  </head>

  <body>
    <div class="wrapper">
      <nav id="sidebar" class="sidebar js-sidebar">
        <!-- Chargement ici  -->
      </nav>

      <div class="main">
        <!-- <div id="entete"></div> -->
        <nav class="navbar navbar-expand navbar-light navbar-bg">
          <a class="sidebar-toggle js-sidebar-toggle">
            <i class="hamburger align-self-center"></i>
          </a>

          <div class="navbar-collapse collapse">
            <ul class="navbar-nav navbar-align">
              <li class="nav-item dropdown">
                <a
                  class="nav-icon dropdown-toggle d-inline-block d-sm-none"
                  href="#"
                  data-bs-toggle="dropdown"
                >
                  <i class="align-middle" data-feather="settings"></i>
                </a>

                <a
                  class="nav-link dropdown-toggle d-none d-sm-inline-block"
                  href="#"
                  data-bs-toggle="dropdown"
                >
                  <img
                    id="userPhoto"
                    src="img/avatars/avatar.jpg"
                    class="avatar img-fluid rounded me-1"
                    alt="Charles Hall"
                  />
                  <span class="text-dark" id="userName">Michel</span>
                </a>
                <div class="dropdown-menu dropdown-menu-end">
                  <a class="dropdown-item" href="#"
                    ><i class="align-middle me-1" data-feather="user"></i>
                    Profil</a
                  >
                  <div class="dropdown-divider"></div>
                  <a class="dropdown-item" id="logout_btn" href="#"
                    >Se d√©connecter</a
                  >
                </div>
              </li>
            </ul>
          </div>
        </nav>

        <main class="content mt-4">
          <h1 class="h3 mb-3">üìú Historique des recherches</h1>

          <a href="recherche-documents" class="btn btn-secondary mb-3"
            >‚¨ÖÔ∏è Retour √† la recherche</a
          >

          <!-- Tableau historique -->
          <div class="table-responsive-sm">
            <table
              id="historyTable"
              class="table table-striped table-bordered dt-responsive nowrap"
              style="width: 100%; min-width: 700px"
            >
              <thead>
                <tr>
                  <th>Date</th>
                  <th>Utilisateur</th>
                  <th>Role</th>
                  <th>Facult√©</th>
                  <th>Service</th>
                  <th>R√©sultats (#docs)</th>
                  <th>Actions</th>
                </tr>
              </thead>
              <tbody></tbody>
            </table>
          </div>

          <!-- D√©tails recherche -->
          <div
            id="detailsSection"
            class="details-section"
            style="display: none"
          >
            <h4>R√©sultats de la recherche</h4>
            <table id="resultTable" class="display" style="width: 100%">
              <thead>
                <tr>
                  <th>Description</th>
                  <th>Code</th>
                  <th>Cat√©gorie</th>
                  <th>Date</th>
                  <th>Niveau</th>
                  <th>Ouvrir</th>
                </tr>
              </thead>
              <tbody></tbody>
            </table>

            <iframe id="previewFrame" class="preview-frame"></iframe>
          </div>
        </main>
        <div id="footer"></div>
      </div>
    </div>

    <script>
      $(document).ready(async function () {
        // ----------------------
        // Load historique
        // ----------------------
        async function loadHistory() {
          const history = await $.get("/api/rechercher");

          history.forEach((h) => {
            try {
              h.list_ids = JSON.parse(h.resultat);
            } catch {
              h.list_ids = [];
            }
          });

          historyTable.clear().rows.add(history).draw();
        }

        // Initial data load
        const initialHistory = await $.get("/api/rechercher");
        initialHistory.forEach((h) => {
          try {
            h.list_ids = JSON.parse(h.resultat);
          } catch {
            h.list_ids = [];
          }
        });

        // ----------------------
        // Table historique
        // ----------------------
        let historyTable = $("#historyTable").DataTable({
          data: initialHistory,
          columns: [
            { data: "date" },
            {
              data: null,
              render: function (data, type, row) {
                return `${row.nom || ""} ${row.postnom || ""}`.trim();
              },
            },
            { data: "role" },
            { data: "des_faculte" },
            { data: "des_service" },
            {
              data: "list_ids",
              render: (arr) => `${arr.length} document(s)`,
            },
            {
              data: null,
              render: (h) => `
                  <button class="btn btn-info btn-sm viewDetails" data-ids='${JSON.stringify(
                    h.list_ids
                  )}'>
                      üëÅÔ∏è Voir
                  </button>

                  <button class="btn btn-danger btn-sm deleteSearch" data-id="${
                    h.id
                  }">
                      üóëÔ∏è
                  </button>
                `,
            },
          ],
        });

        // ----------------------
        // Suppression d‚Äôune recherche
        // ----------------------
        $("#historyTable").on("click", ".deleteSearch", async function () {
          const id = $(this).attr("data-id");

          if (!confirm("Voulez-vous vraiment supprimer cette recherche ?")) {
            return;
          }

          try {
            await $.ajax({
              url: `/api/rechercher/${id}`,
              type: "DELETE",
            });

            alert("Recherche supprim√©e !");
            loadHistory(); // Recharge la table
          } catch (e) {
            alert("Erreur lors de la suppression.");
          }
        });

        // ----------------------
        // Table r√©sultats d‚Äôune recherche
        // ----------------------
        let resultTable = $("#resultTable").DataTable({
          columns: [
            { data: "description" },
            { data: "code" },
            { data: "categorie_designation" },
            { data: "date_created" },
            { data: "niveau_conf" },
            {
              data: "url",
              render: function (url) {
                return url
                  ? `<button class="btn btn-primary btn-sm openDoc" data-url="${url}">üìÑ Ouvrir</button>`
                  : "Aucun fichier";
              },
            },
          ],
        });

        // ----------------------
        // Voir d√©tails
        // ----------------------
        $("#historyTable").on("click", ".viewDetails", async function () {
          const ids = JSON.parse($(this).attr("data-ids"));
          $("#detailsSection").show();

          const documents = await $.get("/api/document");

          const result = documents.filter((d) => ids.includes(d.id));

          resultTable.clear().rows.add(result).draw();

          $("#previewFrame").hide();
        });

        // ----------------------
        // Voir document dans iframe
        // ----------------------
        $("#resultTable").on("click", ".openDoc", function () {
          const url = $(this).data("url");
          $("#previewFrame").attr("src", url).show();
          window.scrollTo({
            top: document.body.scrollHeight,
            behavior: "smooth",
          });
        });
      });
    </script>
    <script>
      $(document).ready(function () {
        $("#sidebar").load("sidebar.html", function () {
          feather.replace(); // Recharger les ic√¥nes Feather apr√®s injection
        });
        $("#footer").load("footer.html", function () {});
      });
      // Charger les infos utilisateur dans l'ent√™te
      $(document).ready(function () {
        $.get("/api/session", function (data) {
          if (data.connected) {
            $("#userName").text(data.user.nom + " " + data.user.postnom);
            $("#userPhoto").attr(
              "src",
              data.user.photo || "img/avatars/avatar.jpg"
            );
          } else {
            $("#userName").text("Invit√©");
            $("#userPhoto").attr("src", "img/avatars/avatar.jpg");
          }
        });
      });
    </script>
    <script src="js/app.js"></script>
  </body>
</html>
